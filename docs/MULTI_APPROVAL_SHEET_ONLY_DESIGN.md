# Sheet-Only Multi-Approver Workflow Design

## Goals and constraints
- Deliver optional multi-approver gating for control-sheet edits without relying on custom menus (sheet editors cannot run Apps Script menu handlers).
- All interactions for requesting, approving, or denying changes must happen through sheet edits and validations that the installable triggers can observe.
- Keep the default behavior unchanged when the required approval count is `1`.

## Core sheet surfaces
### Config sheet additions
- `ApprovalsEnabled` (boolean) – turns the feature on/off. Default: `FALSE` to preserve current behavior.
- `RequiredApprovals` (number) – minimum distinct approvers for each request. Default: `1`. Reject values <1 and warn if the value is higher than the number of sheet editors listed in `SheetEditors`.
- `ApprovalExpiryHours` (number, optional) – auto-expire stale requests (e.g., 72 hours).

### ChangeRequests sheet (new)
A dedicated table that sheet editors can edit directly. Suggested columns:

| Column | Purpose |
| --- | --- |
| `RequestId` | Unique ID (generated by the script or provided by the requester if simple). |
| `RequestedBy` | Email of requester (manual entry; script overwrites with the editor email if captured from the edit event). |
| `RequestedAt` | Timestamp (data validation rule can default to NOW(); script normalizes). |
| `TargetSheet` | Name of control sheet to change (e.g., `ManagedFolders`, `Permissions`). |
| `TargetRowKey` | Primary key / identifier for the target row (e.g., folder ID or user+folder key). |
| `Action` | `ADD`, `UPDATE`, or `DELETE`. |
| `ProposedRowSnapshot` | Serialized values for the intended row (e.g., JSON or pipe-separated columns). |
| `Status` | `PENDING`, `APPROVED`, `DENIED`, `CANCELLED`, `APPLIED`, `EXPIRED`. Data validation enforces allowed values. |
| `ApprovalsNeeded` | Derived from `RequiredApprovals`; computed by script for each row. |
| `Approver_1..N` | Each column holds one approver email. Deduplicate and reject the requester when `RequiredApprovals > 1`. |
| `DenyReason` | Free text when `Status = DENIED` or `CANCELLED`. |
| `AppliedAt` | Timestamp when the change is pushed to the control sheet. |

### Optional views
- **ChangeQueue**: A filtered view or helper sheet showing rows where `Status = PENDING` or `Status = APPROVED` with remaining approvals.
- **Health banner row**: A top row in `ChangeRequests` that the script updates with warnings (e.g., “Required approvals (3) exceed available sheet editors (2)”).

## End-to-end workflow (no menus)
1. **Request capture**
   - Requester fills a new row in `ChangeRequests` with `Action`, `TargetSheet`, `TargetRowKey`, and `ProposedRowSnapshot`.
   - Data validation on `Status` defaults to `PENDING`. A simple checkbox (TRUE/FALSE) can set `ApprovalsEnabled` on the Config sheet.
   - An installable `onChange`/time-driven trigger normalizes the row (fills `RequestId`, `RequestedBy`, `RequestedAt`, `ApprovalsNeeded`).
   - The script refuses to stage changes if `RequiredApprovals` exceeds the distinct sheet editors, and writes the warning into the banner row.

2. **Approval / denial via cells**
   - Other sheet editors type their email into the next empty `Approver_*` column. Data validation can restrict entries to the `SheetEditors` list.
   - The script tallies unique approvers on each trigger run. When the count meets `ApprovalsNeeded`, it flips `Status` to `APPROVED`.
   - To deny, an editor sets `Status` to `DENIED` or `CANCELLED` and can add a `DenyReason`. The script marks the row immutable once denied or cancelled.

3. **Applying approved changes**
   - The AutoSync loop (or a dedicated time-driven trigger) scans for rows with `Status = APPROVED`.
   - For each approved row:
     - Validate the target row still matches the latest control-sheet state (to avoid clobbering newer edits).
     - Apply the change to the target control sheet:
       - `ADD`: append the proposed row.
       - `UPDATE`: match by `TargetRowKey` and replace/update columns.
       - `DELETE`: remove or mark inactive by key.
     - Log success/failure in the Log sheet, set `Status = APPLIED`, and record `AppliedAt`.
   - If validation fails (e.g., key missing), set `Status = DENIED` with a reason.

4. **Expiry and cleanup**
   - A scheduled trigger checks `RequestedAt` + `ApprovalExpiryHours`; if exceeded and still pending, set `Status = EXPIRED` and log it.
   - Provide a filter view or cleanup script to purge old `APPLIED`/`EXPIRED` rows after a retention period.

## Safeguards and UX notes (sheet-first)
- **Protected ranges**: Protect the header and computed columns in `ChangeRequests`; only allow editing of request input cells, `Status`, and `Approver_*` columns.
- **Color cues**: Conditional formatting for `PENDING` (yellow), `APPROVED` (green), `DENIED/EXPIRED` (red/grey) to guide sheet editors without menus.
- **Error messaging**: The top banner row shows the latest validation error (e.g., missing `TargetRowKey`, approvals > editors, or malformed `ProposedRowSnapshot`).
- **No self-approval**: The script ignores `Approver_*` entries matching `RequestedBy` when `RequiredApprovals > 1`.
- **Idempotency**: The script tracks `RequestId` in Document Properties to avoid reapplying already-applied rows if a trigger reruns.

## Rollout approach
1. Ship the new sheet templates (`ChangeRequests`, optional `ChangeQueue`) and Config entries in a migration script.
2. Add validation hooks to skip AutoSync edits when `ApprovalsEnabled = FALSE` or `RequiredApprovals = 1` (preserves existing behavior).
3. Introduce the new triggers: one for normalizing requests (on change) and another inside AutoSync to apply `APPROVED` rows.
4. Update the user guides to explain how to fill `ChangeRequests` and how many approvals are required.

## Limitations
- Approvals remain asynchronous; users should not expect immediate application after adding approvers because triggers run on schedule.
- Free-form `ProposedRowSnapshot` requires clear formatting guidance to avoid malformed updates; consider providing helper formulas (e.g., `TEXTJOIN`) to assemble payloads.
- Concurrent requests touching the same `TargetRowKey` should be blocked or queued by the script to avoid conflicts.

## Implementation effort and risk outlook
- **Complexity level: moderate, bounded** – The feature layers on existing trigger-driven flows and sheet-based validation, so it does not require new infrastructure. Most effort sits in schema migration, trigger wiring, and idempotent state handling rather than novel APIs.
- **Safe-by-default toggle** – With `ApprovalsEnabled = FALSE` or `RequiredApprovals = 1`, current behavior is preserved. This containment limits blast radius during rollout and allows phased enablement per environment.
- **Key risk areas to watch**:
  - **Conflict resolution**: Requests that overlap on the same row/key need guardrails to prevent clobbering. Expect to add conflict checks and clear error messaging.
  - **Data quality of proposed changes**: Since requests are cell-driven, malformed snapshots can lead to denial loops. Strong validation, protected columns, and helper formulas reduce this risk.
  - **Trigger throughput and quotas**: Additional time-driven/on-change work increases Apps Script execution counts. Keeping logic lightweight and batching approvals in the AutoSync loop mitigates quota pressure.
  - **Approver availability**: If `RequiredApprovals` exceeds available editors or editors are inactive, requests can stall. The banner warnings and denial/expiry flow surface this early.
- **Overall expectation** – With careful validation and conflict handling, this is a reasonable and safe enhancement that should be implementable without excessive effort. The main work items are schema setup, approval counting, and sync gating; each is well-scoped and incremental.
