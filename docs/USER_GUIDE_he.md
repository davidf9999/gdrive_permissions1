# מדריך למשתמש: מנהל הרשאות Google Drive

ברוכים הבאים! מדריך זה מסביר כיצד להשתמש בגליון Google לניהול הרשאות תיקיות לאחר שההתקנה הראשונית הושלמה.

---

## הרעיון המרכזי

המערכת פועלת על־ידי קישור תיקיות Google Drive לקבוצות Google. במקום לשתף תיקיה עם מאות כתובות אימייל בודדות, משתפים אותה עם קבוצה אחת (לדוגמה: `my-project-editors@your-domain.com`). לאחר מכן ניתן לשלוט בגישה על־ידי הוספה או הסרה של אנשים מהקבוצה.

הגליון הזה הוא לוח הבקרה המרכזי של כל התהליך. הסקריפט קורא את ההגדרות מהגליונות הללו, ויוצר אוטומטית את הקבוצות, מנהל את החברים בהן, ומגדיר את ההרשאות הנכונות על התיקיות.

---

## גליונות הבקרה

לאחר שמפעילים את הסקריפט בפעם הראשונה, נוצרים מספר גליונות באופן אוטומטי. להלן פירוט של תפקידיהם.

### 1. `ManagedFolders` (גליון הבקרה הראשי)

זהו הגליון החשוב ביותר. כל שורה מייצגת תיקיה שהסקריפט ינהל.

* **`FolderName` (עמודה A):** שם תיקיית Google Drive. 
  * אם לא קיימת תיקיה בשם הזה, הסקריפט ייצור אותה עבורך.
  * אם קיימת תיקיה בשם הזה, הסקריפט יאתר אותה וישתמש בה.
* **`FolderID` (עמודה B):** המזהה הייחודי של התיקיה. 
  * אפשר להשאיר ריק. הסקריפט ימצא או ייצור את התיקיה לפי ה־`FolderName` וימלא את ה־ID עבורך.
  * אם יש כמה תיקיות עם אותו שם, ניתן להדביק כאן את ה־ID הספציפי כדי למנוע בלבול.
* **`Role` (עמודה C):** רמת ההרשאה שברצונך להעניק. ניתן לבחור מתוך התפריט:
  * `Editor`: יכול לארגן, להוסיף ולערוך קבצים.
  * `Viewer`: יכול לצפות בקבצים.
  * `Commenter`: יכול להוסיף הערות.
* **`UserSheetName` (עמודה D):** *מנוהל על־ידי הסקריפט.* שם הגליון שיכיל את רשימת המשתמשים עבור השילוב תיקיה/הרשאה (למשל: `MyProject_Editor`).
* **`GroupEmail` (עמודה E):** *מנוהל על־ידי הסקריפט.* כתובת האימייל של קבוצת Google.
* **`Last Synced` (עמודה F):** *מנוהל על־ידי הסקריפט.* חותמת זמן של הסנכרון האחרון.
* **`Status` (עמודה G):** *מנוהל על־ידי הסקריפט.* מציג את סטטוס הסנכרון האחרון (`OK`, `Processing...` או הודעת שגיאה).

### 2. גליונות משתמשים (לדוגמה: `MyProject_Editor`)

עבור כל שורה ב־`ManagedFolders`, הסקריפט יוצר גליון משתמש מתאים. שמו מופיע בעמודת `UserSheetName`.

* **מטרה:** כאן מוסיפים את כתובות האימייל של האנשים שצריכים לקבל את ההרשאה לתיקיה.
* **שימוש:** להוסיף או להסיר כתובות אימייל בעמודה A.

**חשוב: בדיקת כפילויות בכתובות אימייל**
- כל כתובת אימייל חייבת להופיע **פעם אחת בלבד** בכל גיליון (לא תלוי רישיות)
- המערכת תזהה אוטומטית כפילויות ותעצור את העיבוד של אותה תיקיה עם הודעת שגיאה ברורה
- דוגמה לשגיאה: `"user@domain.com" מופיע בשורות 2, 5, 8`
- השתמש באפשרות **"Validate All User Sheets"** בתפריט כדי לבדוק את כל הגליונות בבת אחת
- כפילויות מונעות פעולות סנכרון כדי לשמור על תקינות הנתונים

### 3. `UserGroups`

גליון זה מאפשר ליצור קבוצות משתמשים לשימוש חוזר.

* **`GroupName` (עמודה A):** שם ידידותי לקבוצה (למשל: "צוות שיווק", "מפתחי פרויקט X").
* **`GroupEmail` (עמודה B):** *מנוהל על־ידי הסקריפט.* הסקריפט יוצר את כתובת האימייל של הקבוצה.
* **איך זה עובד:** עבור כל `GroupName`, הסקריפט יוצר גליון בשם הזה. שם מזינים את חברי הקבוצה. ניתן להשתמש ב־`GroupEmail` בגליונות המשתמשים כדי להעניק הרשאה לכל חברי הקבוצה.

### 4. `Admins`

גליון זה שולט במי יכול לערוך את הגליון הראשי. יש להוסיף את כתובות האימייל של המנהלים.

כל סנכרון מנהל גם קבוצת Google ייעודית שמכילה את אותם מנהלים. בעמודה **B** תופיע כתובת הדוא"ל של הקבוצה לשיתוף מהיר עם כל תיקיה מנוהלת, ובעמודות **C–D** יוצגו מועד הסנכרון האחרון והסטטוס של הקבוצה.

### 5. `Config`

כאן ניתן להגדיר אפשרויות מתקדמות, כמו קבלת התראות במקרה של שגיאות בסקריפט. הגיליון גם מציג מידע חשוב של המערכת:

- **AdminGroupEmail**: מציג את כתובת האימייל של קבוצת המנהלים (לדוגמה: `admins-control-panel@yourdomain.com`). מתעדכן אוטומטית כשמריצים "Sync Admins" וניתן להשתמש בכתובת זו כדי להעניק למנהלים גישה לכל תיקיה מנוהלת על־ידי הוספת כתובת הקבוצה לגיליון המשתמשים של התיקיה.

### 6. `Log` ו־`TestLog`

גליונות אלה מכילים לוגים מפורטים עם חותמות זמן של כל הפעולות שהסקריפט מבצע. שימושיים לאיתור בעיות.

---

## בדיקת גליונות משתמשים לכפילויות בכתובות אימייל

כדי לשמור על תקינות הנתונים ולמנוע שגיאות סנכרון, המערכת בודקת אוטומטית שכל כתובת אימייל מופיעה רק פעם אחת בכל גיליון משתמשים (לא תלוי רישיות). הבדיקה מתבצעת אוטומטית במהלך פעולות סנכרון ואודיט.

### בדיקה אוטומטית

בדיקת כפילויות מתבצעת אוטומטית במצבים הבאים:
- **במהלך פעולות סנכרון**: לפני עיבוד כל תיקיה, הסקריפט בודק את גיליון המשתמשים שלה
- **במהלך אודיט**: כל גיליון משתמשים נבדק לפני בדיקת חברות בקבוצה
- **בגישה לגליונות קיימים**: אם גיליון משתמשים כבר קיים עם נתונים, הוא נבדק לפני שימוש

אם נמצאו כפילויות, הסקריפט:
- יעצור את העיבוד של אותה תיקיה/קבוצה ספציפית
- ירשום הודעת שגיאה ברורה עם כתובות האימייל הכפולות ומספרי השורות המדויקים
- יעדכן את הסטטוס של התיקיה להציג את שגיאת הבדיקה
- ימשיך לעבד תיקיות אחרות כרגיל (לא חוסם)

### בדיקה ידנית: "Validate All User Sheets"

ניתן לבדוק ידנית את כל גליונות המשתמשים בבת אחת באמצעות אפשרות התפריט: **Permissions Manager > Validate All User Sheets**

הבדיקה תבצע:
1. בדיקה של כל גליונות המשתמשים מ־`ManagedFolders`, `UserGroups` ו־`Admins`
2. תציג סיכום המראה אילו גליונות יש בהם שגיאות
3. תספק מידע מפורט על כל כפילות שנמצאה

**דוגמה לפלט:**
```
Validated 10 user sheets.

Sheets with errors: 2
Sheets without errors: 8

Details:
✓ Project_A_Editors: OK
✓ Project_A_Viewers: OK
❌ Project_B_Editors: Duplicate emails found: "user@domain.com" appears in rows 3, 7
✓ Project_C_Editors: OK
❌ Marketing_Team: Duplicate emails found: "admin@company.com" appears in rows 2, 5, 9
✓ Admins: OK
...
```

### תיקון שגיאות כפילויות

כאשר רואים שגיאת בדיקה:
1. שימו לב באיזה גיליון יש בעיה
2. פתחו את הגיליון והסתכלו על מספרי השורות שהוזכרו
3. הסירו את הערכים הכפולים (השאירו רק מופע אחד של כל אימייל)
4. הריצו מחדש את הסנכרון או הבדיקה כדי לאשר שהבעיה נפתרה

**זכרו:** השוואת אימיילים אינה תלויה רישיות, כך ש־`user@domain.com`, `USER@domain.com` ו־`UsEr@DoMaIn.CoM` כולם נחשבים ככפילויות.

---

## תרחישים נפוצים

### איך להעניק לצוות גישה לתיקיה חדשה

נניח שברצונך לתת ל"צוות המכירות" הרשאת עורך לתיקיה חדשה בשם "Q4 Sales Reports".

1. עבור לגליון `ManagedFolders`.
2. בשורה חדשה, הזן:
   * `FolderName`: `Q4 Sales Reports`
   * `Role`: `Editor`
3. עבור לגליון `UserGroups`.
4. בשורה חדשה, הזן:
   * `GroupName`: `Sales Team`
5. הפעל את הסנכרון הראשון: **Permissions Manager > Sync All**.
6. הסקריפט ירוץ ויבצע:
   * יצירת תיקיה "Q4 Sales Reports" ב־Google Drive.
   * יצירת גליון משתמש בשם `Q4 Sales Reports_Editor`.
   * יצירת קבוצת Google עבור Sales Team וגליון בשם `Sales Team`.
7. עבור לגליון `Sales Team` והוסף את כתובות האימייל של חברי הצוות בעמודה A.
8. עבור לגליון `Q4 Sales Reports_Editor` והוסף בעמודה A את כתובת האימייל של הקבוצה (מועתקת מ־`GroupEmail` בגליון `UserGroups`).
9. הפעל סנכרון סופי: **Permissions Manager > Sync All**.

הסקריפט יוסיף את כל חברי Sales Team ל־`Q4 Sales Reports_Editor`, ובכך יעניק להם הרשאת עריכה.

### איך להוסיף/להסיר משתמש

1. אתר את גליון המשתמשים המתאים (למשל: `Q4 Sales Reports_Editor`).
2. להוסיף משתמש – הוסף את כתובת האימייל שלו לשורה חדשה בעמודה A.
3. להסיר משתמש – מחק את השורה שבה מופיעה כתובת האימייל שלו.
4. הפעל **Permissions Manager > Sync All**.
